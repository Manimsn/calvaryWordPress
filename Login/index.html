<style>
    .backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 99998 !important;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999 !important;
    }

    .modal-content {
        background: #00B5EF;
        padding: 2rem;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .close-button {
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 20px;
        cursor: pointer;
    }

    .hidden {
        display: none !important;
    }

    /* Add to your existing <style> tag */
    #continueButton:disabled {
        background-color: #999 !important;
        cursor: not-allowed !important;
        border: none !important;
    }


    #continueButton {
        background-color: #333;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease, cursor 0.3s ease;
    }

    #loginInput {
        border-radius: 12px !important;
        -webkit-border-radius: 12px !important;
        -moz-border-radius: 12px !important;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        box-sizing: border-box;
    }

    .otpBox {
        width: 40px;
        height: 50px;
        text-align: center;
        font-size: 24px;
        border-radius: 10px;
        border: 1px solid white !important;
        background-color: transparent !important;
        color: white !important;
        outline: none;
    }
</style>

<!-- Button -->
<button id="openLoginModal"
    style="z-index: 1; position: relative; padding: 10px 20px; border-radius: 8px; background-color: #333; color: white; border: none;">
    Login
</button>

<!-- Modal + Backdrop -->
<div id="customBackdrop" class="backdrop hidden"></div>
<div id="customLoginModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button">&times;</span>

        <!-- Logo (Replace logo.png with your own) -->
        <div style="text-align: center;">
            <img src="https://calvary2024stg.wpenginepowered.com/wp-content/uploads/2024/08/CalvaryLogo_Suncross_Grey@2x.png"
                alt="Logo" style="width: 80px; margin-bottom: 1rem;" />
        </div>

        <h2 style="text-align: center; color: white; font-family: 'Poppins'; font-size: 40px; padding-bottom: 30px;">
            Welcome!
        </h2>
        <p style="text-align: left; color: white; font-family: 'Poppins'; font-size: 18px;">
            Type in your phone number or email to continue
        </p>

        <!-- Input -->
        <input id="loginInput" type="text" placeholder="Enter email or phone number"
            style="width: 100%; padding: 10px; border-radius: 50px; border: 1px solid #ccc; margin-top: 10px; margin-bottom: 10px;" />

        <!-- Error Message -->
        <div id="inputError" style="color: red; font-size: 12px; margin-top: 5px;"></div>

        <!-- Continue Button -->
        <button id="continueButton" disabled
            style="margin-top: 10px; padding: 10px 30px; border-radius: 50px; background-color: transparent; color: white; border: 1px solid white; display: block; margin-left: auto; margin-right: auto;">
            Continue
        </button>

        <div id="otpSection" style="display: none; flex-direction: column; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 32px;">
                <span id="otpBackArrow" style="cursor: pointer; font-size: 24px;">&#8592;</span>
                <p id="otpText" style="margin: 0; color: white; font-size: 20px;">Enter the code sent to <span
                        id="userValueDisplay" style="font-weight: bold; color: black;"></span></p>
            </div>

            <!-- OTP Boxes aligned with text -->
            <div id="otpWrapper"
            style="display: flex; flex-direction: column; align-items: center; gap: 6px; margin-left: 32px;">
            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <div id="otpBoxes" style="display: flex; gap: 20px;">
                    <input maxlength="1" type="text" class="otpBox" />
                    <input maxlength="1" type="text" class="otpBox" />
                    <input maxlength="1" type="text" class="otpBox" />
                    <input maxlength="1" type="text" class="otpBox" />
                    <input maxlength="1" type="text" class="otpBox" />
                    <input maxlength="1" type="text" class="otpBox" />
                </div>
                <a id="resetCodeLink" href="#" style="margin-top: 4px; color: white; font-size: 14px;">
                    Resend Code
                </a>
            </div>
            </div>

            <button id="signInButton"
                style="margin: 0 auto; padding: 10px 30px; border-radius: 50px; background: white; color: #007bff; border: none; font-weight: bold; cursor: pointer;">
                SIGN IN
            </button>
        </div>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const loginBtn = document.getElementById("openLoginModal");
        const modal = document.getElementById("customLoginModal");
        const backdrop = document.getElementById("customBackdrop");
        const closeBtn = modal.querySelector(".close-button");

        const input = document.getElementById("loginInput");
        const error = document.getElementById("inputError");
        const continueBtn = document.getElementById("continueButton");

        // Show modal
        loginBtn.addEventListener("click", () => {
            modal.classList.remove("hidden");
            backdrop.classList.remove("hidden");
        });

        // Hide modal
        closeBtn.addEventListener("click", () => {
            modal.classList.add("hidden");
            backdrop.classList.add("hidden");
            input.value = "";
            error.innerText = "";
            input.style.borderColor = "#ccc";
            continueBtn.disabled = true;
            continueBtn.style.cursor = "not-allowed";
        });

        // Validation on input
        input.addEventListener("input", () => {
            const value = input.value.trim();

            const isValid = validateEmail(value) || validatePhone(value);

            if (isValid) {
                input.style.borderColor = "#ccc";
                error.innerText = "";
                continueBtn.disabled = false;
            } else {
                input.style.borderColor = "red";
                error.innerText = "Enter a valid email or 10-digit US/India phone number.";
                continueBtn.disabled = true;
            }
        });


        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
            return re.test(email);
        }


        function validatePhone(phone) {
            // Reject if it contains anything other than digits, space, +, or dash
            const allowedChars = /^[\d\s\+\-]+$/;
            if (!allowedChars.test(phone)) return false;

            const cleaned = phone.replace(/\D/g, ""); // Remove everything except digits
            const isIndian = /^[6-9]\d{9}$/.test(cleaned);
            const isUS = /^\d{10}$/.test(cleaned);
            return isIndian || isUS;
        }


        continueBtn.addEventListener("click", async () => {
            const value = input.value.trim();
            continueBtn.disabled = true;
            continueBtn.innerText = "Sending...";

            try {
                const response = await fetch("https://mobileserver.calvaryftl.org/api/LoginCode", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Phone_Email: value })
                });

                const text = await response.text();

                if (!response.ok) {
                    input.style.borderColor = "red";
                    error.innerText = text;
                    continueBtn.disabled = false;
                    continueBtn.innerText = "Continue";
                } else {
                    // âœ… Show OTP Section
                    // âœ… Show OTP Section
                    document.getElementById("otpSection").style.display = "flex";
                    document.getElementById("userValueDisplay").innerText = value;

                    // Hide previous content
                    document.querySelector("img").style.display = "none"; // Logo
                    document.querySelector("h2").style.display = "none";
                    document.querySelector("p").style.display = "none";
                    input.style.display = "none";
                    continueBtn.style.display = "none";
                    error.innerText = "";

                    // Set up OTP input auto-focus
                    const otpInputs = document.querySelectorAll(".otpBox");
                    otpInputs[0].focus(); // ðŸ‘ˆ Autofocus first OTP input

                    otpInputs.forEach((input, index) => {
                        input.addEventListener("input", (e) => {
                            const value = e.target.value;
                            if (!/^\d$/.test(value)) {
                                e.target.value = "";
                                return;
                            }
                            if (value && index < otpInputs.length - 1) {
                                otpInputs[index + 1].focus();
                            }
                        });

                        input.addEventListener("keydown", (e) => {
                            if (e.key === "Backspace" && !e.target.value && index > 0) {
                                otpInputs[index - 1].focus();
                            }
                        });
                    });
                }
            } catch (err) {
                input.style.borderColor = "red";
                error.innerText = "Something went wrong. Please try again.";
                continueBtn.disabled = false;
                continueBtn.innerText = "Continue";
            }
        });

    });
</script>